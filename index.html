<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10-Min Revision - Your AI Study Buddy for NEET</title>
    <link rel="icon" href="data:,">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #eef2ff 0%, #ffffff 50%, #faf5ff 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .flex {
            display: flex;
        }
        
        .flex-col {
            flex-direction: column;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-center {
            justify-content: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .gap-8 { gap: 2rem; }
        
        .min-h-screen {
            min-height: 100vh;
        }
        
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .font-bold {
            font-weight: 700;
        }
        
        .font-semibold {
            font-weight: 600;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        .rounded-xl {
            border-radius: 0.75rem;
        }
        
        .rounded-2xl {
            border-radius: 1rem;
        }
        
        .rounded-3xl {
            border-radius: 1.5rem;
        }
        
        .rounded-full {
            border-radius: 9999px;
        }
        
        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .shadow-xl {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .shadow-2xl {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .bg-white {
            background-color: #ffffff;
        }
        
        .bg-gradient {
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
        }
        
        .bg-gray-100 {
            background-color: #f3f4f6;
        }
        
        .bg-gray-200 {
            background-color: #e5e7eb;
        }
        
        .text-white {
            color: #ffffff;
        }
        
        .text-gray-500 {
            color: #6b7280;
        }
        
        .text-gray-600 {
            color: #4b5563;
        }
        
        .text-gray-700 {
            color: #374151;
        }
        
        .text-gray-800 {
            color: #1f2937;
        }
        
        .text-indigo-600 {
            color: #4f46e5;
        }
        
        .text-purple-600 {
            color: #9333ea;
        }
        
        .text-pink-600 {
            color: #db2777;
        }
        
        .text-red-600 {
            color: #dc2626;
        }
        
        .border {
            border-width: 1px;
        }
        
        .border-2 {
            border-width: 2px;
        }
        
        .border-gray-100 {
            border-color: #f3f4f6;
        }
        
        .border-gray-200 {
            border-color: #e5e7eb;
        }
        
        .border-indigo-500 {
            border-color: #6366f1;
        }
        
        .p-4 { padding: 1rem; }
        .p-5 { padding: 1.25rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .p-10 { padding: 2.5rem; }
        
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-5 { padding-left: 1.25rem; padding-right: 1.25rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-5 { padding-top: 1.25rem; padding-bottom: 1.25rem; }
        .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
        
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        
        .w-6 { width: 1.5rem; }
        .w-7 { width: 1.75rem; }
        .w-10 { width: 2.5rem; }
        .w-24 { width: 6rem; }
        .w-full { width: 100%; }
        
        .h-6 { height: 1.5rem; }
        .h-7 { height: 1.75rem; }
        .h-10 { height: 2.5rem; }
        .h-24 { height: 6rem; }
        
        .max-w-2xl {
            max-width: 42rem;
        }
        
        .max-w-4xl {
            max-width: 56rem;
        }
        
        .max-w-5xl {
            max-width: 64rem;
        }
        
        .max-w-lg {
            max-width: 32rem;
        }
        
        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }
        
        .overflow-y-auto {
            overflow-y: auto;
        }
        
        .flex-1 {
            flex: 1;
        }
        
        .space-y-6 > * + * {
            margin-top: 1.5rem;
        }
        
        .space-y-8 > * + * {
            margin-top: 2rem;
        }
        
        .grid {
            display: grid;
        }
        
        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        
        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
        
        button {
            cursor: pointer;
            border: none;
            outline: none;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: scale(1.05);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        input {
            outline: none;
            transition: all 0.3s ease;
        }
        
        input:focus {
            border-color: #6366f1;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            color: white;
            font-weight: 700;
            padding: 1.25rem;
            border-radius: 0.75rem;
            width: 100%;
            font-size: 1.25rem;
        }
        
        .btn-subject {
            padding: 1.25rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1.125rem;
            background-color: #f3f4f6;
            color: #374151;
        }
        
        .btn-subject:hover {
            background-color: #e5e7eb;
        }
        
        .btn-subject.active {
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            color: white;
        }
        
        .input-field {
            width: 100%;
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            border: 2px solid #e5e7eb;
            font-size: 1.125rem;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .icon-box {
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            padding: 1rem;
            border-radius: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .feature-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 0.75rem;
            padding: 1.25rem;
        }
        
        .message-user {
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            color: white;
            max-width: 32rem;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
        }
        
        .message-ai {
            background: white;
            color: #1f2937;
            max-width: 32rem;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            border: 1px solid #f3f4f6;
        }
        
        .mic-button {
            width: 6rem;
            height: 6rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mic-button.listening {
            background: #dc2626;
            animation: pulse 2s infinite;
        }
        
        .timer-box {
            background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.1); }
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        svg {
            display: block;
        }
        
        @media (max-width: 768px) {
            .grid-cols-3 {
                grid-template-columns: 1fr;
            }
            
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            
            .text-6xl {
                font-size: 3rem;
            }
            
            .text-4xl {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    
    <!-- Setup Screen -->
    <div id="setupScreen" class="min-h-screen flex items-center justify-center p-4">
        <div style="width: 100%; max-width: 42rem;">
            <div class="text-center mb-8">
                <div class="flex items-center justify-center mb-4">
                    <div class="icon-box shadow-lg">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                </div>
                <h1 class="gradient-text mb-3" style="font-size: 4rem; font-weight: 700;">
                    10-Min Revision
                </h1>
                <p class="text-gray-600 font-medium" style="font-size: 1.25rem;">Your AI Study Buddy for NEET</p>
                <p class="text-gray-500 mt-2" style="font-size: 0.875rem;">Master concepts through voice conversations</p>
            </div>

            <div class="bg-white rounded-3xl shadow-2xl p-10 border border-gray-100">
                <div class="space-y-8">
                    <div>
                        <label class="font-bold text-gray-700 mb-3" style="display: block; font-size: 0.875rem;">Select Subject</label>
                        <div class="grid grid-cols-3 gap-4">
                            <button onclick="selectSubject('Physics')" id="btn-Physics" class="btn-subject">
                                Physics
                            </button>
                            <button onclick="selectSubject('Chemistry')" id="btn-Chemistry" class="btn-subject">
                                Chemistry
                            </button>
                            <button onclick="selectSubject('Biology')" id="btn-Biology" class="btn-subject">
                                Biology
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="font-bold text-gray-700 mb-3" style="display: block; font-size: 0.875rem;">What topic do you want to revise?</label>
                        <input type="text" id="topicInput" placeholder="e.g., Laws of Motion, Chemical Bonding, Cell Division..." class="input-field">
                    </div>

                    <button onclick="startSession()" class="btn-primary shadow-xl">
                        <div class="flex items-center justify-center gap-3">
                            <svg style="width: 1.5rem; height: 1.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Start 10min Session
                        </div>
                    </button>
                </div>
            </div>

            <div class="mt-8 grid grid-cols-3 gap-4 text-center">
                <div class="feature-card shadow-md">
                    <svg class="w-7 h-7 text-indigo-600 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                    <p class="text-gray-700 font-semibold" style="font-size: 0.875rem;">Peer Learning</p>
                    <p class="text-gray-500 mt-1" style="font-size: 0.75rem;">Learn like friends</p>
                </div>
                <div class="feature-card shadow-md">
                    <svg class="w-7 h-7 text-purple-600 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                    </svg>
                    <p class="text-gray-700 font-semibold" style="font-size: 0.875rem;">Voice Based</p>
                    <p class="text-gray-500 mt-1" style="font-size: 0.75rem;">Speak naturally</p>
                </div>
                <div class="feature-card shadow-md">
                    <svg class="w-7 h-7 text-pink-600 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-gray-700 font-semibold" style="font-size: 0.875rem;">10 Minutes</p>
                    <p class="text-gray-500 mt-1" style="font-size: 0.75rem;">Quick & effective</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Session Screen -->
    <div id="sessionScreen" class="hidden" style="min-height: 100vh; display: flex; flex-direction: column;">
        <div class="bg-white border-b border-gray-200 px-6 py-4 shadow-md">
            <div class="max-w-5xl mx-auto" style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h2 id="sessionSubject" class="text-gray-800" style="font-size: 1.5rem; font-weight: 700;"></h2>
                    <p id="sessionTopic" class="text-gray-600 font-medium"></p>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="timer-box" style="display: flex; align-items: center; gap: 0.75rem;">
                        <svg style="width: 1.5rem; height: 1.5rem;" class="text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span id="timer" class="text-indigo-600" style="font-size: 1.5rem; font-weight: 700;">10:00</span>
                    </div>
                    <button onclick="endSession()" class="bg-gray-200 rounded-xl font-semibold px-6 py-3">
                        End Session
                    </button>
                </div>
            </div>
        </div>

        <div id="messagesContainer" class="flex-1 overflow-y-auto px-6 py-8" style="flex: 1; overflow-y: auto;">
            <div class="max-w-4xl mx-auto" id="messagesList" style="display: flex; flex-direction: column; gap: 1.5rem;">
            </div>
        </div>

        <div class="bg-white border-t border-gray-200 px-6 py-8 shadow-lg">
            <div class="max-w-4xl mx-auto">
                <div style="display: flex; align-items: center; justify-content: center; gap: 2rem; margin-bottom: 1rem;">
                    <div id="speakingIndicator" class="animate-pulse" style="display: none; align-items: center; gap: 0.75rem; color: #9333ea;">
                        <svg style="width: 1.5rem; height: 1.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                        </svg>
                        <span class="font-semibold">AI is speaking...</span>
                    </div>
                    
                    <button id="micButton" onclick="toggleListening()" class="mic-button shadow-2xl">
                        <svg id="micIcon" style="width: 2.5rem; height: 2.5rem;" class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                        </svg>
                    </button>

                    <div id="listeningIndicator" class="animate-pulse" style="display: none; align-items: center; gap: 0.75rem; color: #dc2626;">
                        <div style="width: 0.75rem; height: 0.75rem; background: #dc2626; border-radius: 50%;"></div>
                        <span class="font-semibold">Listening...</span>
                    </div>
                </div>
                <div class="text-center">
                    <p id="voiceStatus" class="text-gray-600 font-medium">
                        ðŸ‘† Click the mic and start speaking
                    </p>
                    <p class="text-gray-500 mt-2" style="font-size: 0.875rem;">
                        ðŸ’¡ Tip: Speak clearly and naturally. The AI will respond with voice.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Screen -->
    <div id="summaryScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div style="width: 100%; max-width: 42rem;" class="bg-white rounded-3xl shadow-2xl p-10">
            <div class="text-center mb-8">
                <div class="mx-auto mb-6 shadow-xl" style="width: 6rem; height: 6rem; background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 3rem; height: 3rem;" class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                    </svg>
                </div>
                <h2 class="text-gray-800 mb-3" style="font-size: 2.25rem; font-weight: 700;">Session Complete! ðŸŽ‰</h2>
                <p id="summaryText" class="text-gray-600" style="font-size: 1.125rem;"></p>
            </div>

            <div class="rounded-2xl p-8 mb-8" style="background: linear-gradient(135deg, #eef2ff 0%, #faf5ff 100%);">
                <div class="grid grid-cols-2 gap-6 text-center">
                    <div class="bg-white rounded-xl p-6 shadow-md">
                        <p class="text-gray-600 mb-2 font-semibold" style="font-size: 0.875rem;">Subject</p>
                        <p id="summarySubject" class="text-gray-800" style="font-size: 1.25rem; font-weight: 700;"></p>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-md">
                        <p class="text-gray-600 mb-2 font-semibold" style="font-size: 0.875rem;">Topic</p>
                        <p id="summaryTopic" class="text-gray-800" style="font-size: 1.25rem; font-weight: 700;"></p>
                    </div>
                </div>
                <div class="mt-6 bg-white rounded-xl p-6 shadow-md text-center">
                    <p class="text-gray-600 mb-2 font-semibold" style="font-size: 0.875rem;">Messages Exchanged</p>
                    <p id="messageCount" class="text-indigo-600" style="font-size: 1.875rem; font-weight: 700;">0</p>
                </div>
            </div>

            <button onclick="resetSession()" class="btn-primary shadow-xl">
                <div class="flex items-center justify-center gap-3">
                    <svg style="width: 1.5rem; height: 1.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Start New Session
                </div>
            </button>
        </div>
    </div>

<script>
const GEMINI_API_KEY = 'AIzaSyDgA-_s6Sf5ze3D2FAp0sV4iRqq2dRoXtA';

let state = {
    screen: 'setup',
    subject: '',
    topic: '',
    messages: [],
    timeLeft: 600,
    isListening: false,
    isSpeaking: false,
    isActive: false,
    recognition: null,
    synthesis: window.speechSynthesis,
    currentTranscript: '',
    timerInterval: null
};

function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        state.recognition = new SpeechRecognition();
        state.recognition.continuous = false;
        state.recognition.interimResults = true;
        state.recognition.lang = 'en-IN';
        
        state.recognition.onresult = (event) => {
            const transcript = Array.from(event.results).map(r => r[0].transcript).join('');
            state.currentTranscript = transcript;
            if (event.results[event.results.length - 1].isFinal) {
                setTimeout(() => stopListening(), 500);
            }
        };
        
        state.recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            state.isListening = false;
            updateUI();
            if (event.error === 'not-allowed') {
                alert('Microphone permission denied. Please allow microphone access.');
            }
        };
        
        state.recognition.onend = () => {
            state.isListening = false;
            updateUI();
        };
    } else {
        alert('Voice recognition is not supported in your browser. Please use Chrome, Edge, or Safari.');
    }
}

function selectSubject(subject) {
    state.subject = subject;
    ['Physics', 'Chemistry', 'Biology'].forEach(subj => {
        const btn = document.getElementById(`btn-${subj}`);
        if (subj === subject) {
            btn.className = 'btn-subject active';
        } else {
            btn.className = 'btn-subject';
        }
    });
}

async function startSession() {
    state.topic = document.getElementById('topicInput').value.trim();
    
    if (!state.subject || !state.topic) {
        alert('Please select a subject and enter a topic');
        return;
    }
    
    state.screen = 'session';
    state.isActive = true;
    state.timeLeft = 600;
    state.messages = [];
    
    updateUI();
    
    document.getElementById('sessionSubject').textContent = state.subject;
    document.getElementById('sessionTopic').textContent = state.topic;
    
    const greeting = `Hey! Let's spend the next 10 minutes understanding ${state.topic} in ${state.subject}. I'm here as your study buddy, not to quiz you, but to explore this concept together. So tell me, what do you already know about ${state.topic}?`;
    
    state.messages.push({ role: 'assistant', content: greeting });
    displayMessages();
    await speak(greeting);
    
    startTimer();
}

function startTimer() {
    if (state.timerInterval) clearInterval(state.timerInterval);
    
    state.timerInterval = setInterval(() => {
        if (state.isActive && state.timeLeft > 0) {
            state.timeLeft--;
            updateTimer();
        } else if (state.timeLeft === 0) {
            clearInterval(state.timerInterval);
            endSession();
        }
    }, 1000);
}

function updateTimer() {
    const mins = Math.floor(state.timeLeft / 60);
    const secs = state.timeLeft % 60;
    const timeString = `${mins}:${secs.toString().padStart(2, '0')}`;
    const timerEl = document.getElementById('timer');
    if (timerEl) {
        timerEl.textContent = timeString;
        timerEl.style.color = state.timeLeft < 60 ? '#dc2626' : '#4f46e5';
    }
}

function toggleListening() {
    if (state.isSpeaking) return;
    state.isListening ? stopListening() : startListening();
}

function startListening() {
    if (state.recognition && !state.isListening && !state.isSpeaking) {
        try {
            state.recognition.start();
            state.isListening = true;
            updateUI();
        } catch (error) {
            console.error('Failed to start recognition:', error);
        }
    }
}

function stopListening() {
    if (state.recognition && state.isListening) {
        state.recognition.stop();
        state.isListening = false;
        if (state.currentTranscript.trim()) {
            handleUserMessage(state.currentTranscript.trim());
            state.currentTranscript = '';
        }
        updateUI();
    }
}

function speak(text) {
    return new Promise((resolve) => {
        state.synthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        
        utterance.rate = 0.95;
        utterance.pitch = 1.05;
        utterance.volume = 1.0;
        
        const voices = state.synthesis.getVoices();
        const preferredVoice = voices.find(v => 
            v.lang.startsWith('en') && 
            (v.name.includes('Google') || v.name.includes('Natural') || v.name.includes('Premium'))
        ) || voices.find(v => v.lang.startsWith('en'));
        
        if (preferredVoice) utterance.voice = preferredVoice;
        
        utterance.onstart = () => {
            state.isSpeaking = true;
            updateUI();
        };
        
        utterance.onend = () => {
            state.isSpeaking = false;
            updateUI();
            resolve();
        };
        
        utterance.onerror = (error) => {
            console.error('Speech synthesis error:', error);
            state.isSpeaking = false;
            updateUI();
            resolve();
        };
        
        state.synthesis.speak(utterance);
    });
}

async function handleUserMessage(text) {
    state.messages.push({ role: 'user', content: text });
    displayMessages();
    
    try {
        const conversationHistory = state.messages.map(msg => ({
            role: msg.role === 'assistant' ? 'model' : 'user',
            parts: [{ text: msg.content }]
        }));
        
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: conversationHistory,
                systemInstruction: {
                    parts: [{
                        text: `You are a friendly study buddy helping a NEET student revise ${state.subject} - ${state.topic}. 

IMPORTANT GUIDELINES:
- Act like a peer/friend, NOT a teacher or examiner
- Keep responses concise (2-3 sentences max) since this will be spoken aloud
- Ask conceptual questions and create real-world scenarios
- Help them UNDERSTAND deeply, not just memorize
- Be encouraging and supportive
- Use simple, conversational language
- If they seem stuck, give hints instead of direct answers
- Relate concepts to everyday examples when possible
- Make learning feel like a friendly discussion, not an interrogation

Your goal: Help them truly grasp ${state.topic} in a fun, engaging way within 10 minutes.`
                    }]
                },
                generationConfig: {
                    temperature: 0.9,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 200,
                }
            })
        });
        
        const data = await response.json();
        
        if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
            const aiResponse = data.candidates[0].content.parts[0].text;
            state.messages.push({ role: 'assistant', content: aiResponse });
            displayMessages();
            await speak(aiResponse);
        } else {
            throw new Error('Invalid response from Gemini API');
        }
    } catch (error) {
        console.error('Error calling Gemini API:', error);
        const errorMsg = "Hmm, I'm having trouble processing that. Can you try again?";
        state.messages.push({ role: 'assistant', content: errorMsg });
        displayMessages();
        await speak(errorMsg);
    }
}

function displayMessages() {
    const messagesList = document.getElementById('messagesList');
    messagesList.innerHTML = '';
    
    state.messages.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.className = `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} animate-fadeIn`;
        msgDiv.style.display = 'flex';
        msgDiv.style.justifyContent = msg.role === 'user' ? 'flex-end' : 'flex-start';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = msg.role === 'user' ? 'message-user shadow-md' : 'message-ai shadow-md';
        
        const textP = document.createElement('p');
        textP.style.fontSize = '1rem';
        textP.style.lineHeight = '1.6';
        textP.textContent = msg.content;
        
        contentDiv.appendChild(textP);
        msgDiv.appendChild(contentDiv);
        messagesList.appendChild(msgDiv);
    });
    
    const container = document.getElementById('messagesContainer');
    if (container) container.scrollTop = container.scrollHeight;
}

function updateUI() {
    const setupScreen = document.getElementById('setupScreen');
    const sessionScreen = document.getElementById('sessionScreen');
    const summaryScreen = document.getElementById('summaryScreen');
    
    if (setupScreen) setupScreen.style.display = state.screen === 'setup' ? 'flex' : 'none';
    if (sessionScreen) sessionScreen.style.display = state.screen === 'session' ? 'flex' : 'none';
    if (summaryScreen) summaryScreen.style.display = state.screen === 'summary' ? 'flex' : 'none';
    
    if (state.screen === 'session') {
        const micButton = document.getElementById('micButton');
        const listeningIndicator = document.getElementById('listeningIndicator');
        const speakingIndicator = document.getElementById('speakingIndicator');
        
        if (micButton) {
            if (state.isListening) {
                micButton.className = 'mic-button listening shadow-2xl';
                if (listeningIndicator) listeningIndicator.style.display = 'flex';
            } else {
                micButton.className = 'mic-button shadow-2xl';
                if (listeningIndicator) listeningIndicator.style.display = 'none';
            }
            
            if (state.isSpeaking) {
                if (speakingIndicator) speakingIndicator.style.display = 'flex';
                micButton.disabled = true;
            } else {
                if (speakingIndicator) speakingIndicator.style.display = 'none';
                micButton.disabled = false;
            }
        }
    }
}

function endSession() {
    state.isActive = false;
    state.screen = 'summary';
    
    if (state.timerInterval) clearInterval(state.timerInterval);
    if (state.recognition) state.recognition.stop();
    
    state.synthesis.cancel();
    state.isListening = false;
    state.isSpeaking = false;
    
    updateUI();
    
    document.getElementById('summarySubject').textContent = state.subject;
    document.getElementById('summaryTopic').textContent = state.topic;
    document.getElementById('messageCount').textContent = state.messages.length;
    document.getElementById('summaryText').textContent = 
        `Great job! You exchanged ${state.messages.length} messages about ${state.topic}. Keep practicing!`;
}

function resetSession() {
    state = {
        screen: 'setup',
        subject: '',
        topic: '',
        messages: [],
        timeLeft: 600,
        isListening: false,
        isSpeaking: false,
        isActive: false,
        recognition: state.recognition,
        synthesis: state.synthesis,
        currentTranscript: '',
        timerInterval: null
    };
    
    document.getElementById('topicInput').value = '';
    
    ['Physics', 'Chemistry', 'Biology'].forEach(subj => {
        document.getElementById(`btn-${subj}`).className = 'btn-subject';
    });
    
    updateUI();
}

document.addEventListener('DOMContentLoaded', function() {
    initSpeechRecognition();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
    }
});
</script>
</body>
</html>
