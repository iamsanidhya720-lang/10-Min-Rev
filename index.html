<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10-Min Revision - Your AI Study Buddy for NEET</title>
    <link rel="icon" href="data:,">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #eef2ff 0%, #ffffff 50%, #faf5ff 100%);
            min-height: 100vh;
        }
        
        .hidden {
            display: none !important;
        }
        
        .screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .session-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 2.5rem;
            max-width: 42rem;
            width: 100%;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 4rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .icon-box {
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            padding: 1rem;
            border-radius: 1rem;
            display: inline-flex;
            width: 4rem;
            height: 4rem;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        
        .btn {
            cursor: pointer;
            border: none;
            outline: none;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .btn:hover:not(:disabled) {
            transform: scale(1.05);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-subject {
            padding: 1.25rem 1rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1.125rem;
            background-color: #f3f4f6;
            color: #374151;
        }
        
        .btn-subject.active {
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            color: white;
            font-weight: 700;
            padding: 1.25rem;
            border-radius: 0.75rem;
            width: 100%;
            font-size: 1.25rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .input-field {
            width: 100%;
            padding: 1rem 1.25rem;
            border-radius: 0.75rem;
            border: 2px solid #e5e7eb;
            font-size: 1.125rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #6366f1;
        }
        
        .mic-button {
            width: 6rem;
            height: 6rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mic-button:hover:not(:disabled) {
            transform: scale(1.1);
        }
        
        .mic-button.listening {
            background: #dc2626;
            animation: pulse 2s infinite;
        }
        
        .message {
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            max-width: 32rem;
            animation: fadeIn 0.3s ease-out;
        }
        
        .message-user {
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            color: white;
            margin-left: auto;
        }
        
        .message-ai {
            background: white;
            color: #1f2937;
            border: 1px solid #f3f4f6;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @media (max-width: 768px) {
            .grid-3, .grid-2 {
                grid-template-columns: 1fr;
            }
            .gradient-text {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    
    <!-- Setup Screen -->
    <div id="setupScreen" class="screen">
        <div class="card">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: center; margin-bottom: 1rem;">
                    <div class="icon-box">
                        <svg style="width: 2.5rem; height: 2.5rem; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                </div>
                <h1 class="gradient-text">10-Min Revision</h1>
                <p style="color: #4b5563; font-weight: 600; font-size: 1.25rem;">Your AI Study Buddy for NEET</p>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 0.75rem; font-size: 0.875rem;">Select Subject</label>
                <div class="grid-3">
                    <button onclick="selectSubject('Physics')" id="btn-Physics" class="btn btn-subject">Physics</button>
                    <button onclick="selectSubject('Chemistry')" id="btn-Chemistry" class="btn btn-subject">Chemistry</button>
                    <button onclick="selectSubject('Biology')" id="btn-Biology" class="btn btn-subject">Biology</button>
                </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 700; color: #374151; margin-bottom: 0.75rem; font-size: 0.875rem;">What topic do you want to revise?</label>
                <input type="text" id="topicInput" placeholder="e.g., Laws of Motion, Chemical Bonding..." class="input-field">
            </div>

            <button onclick="startSession()" class="btn btn-primary">
                <span style="display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                    <svg style="width: 1.5rem; height: 1.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                    </svg>
                    Start 10min Session
                </span>
            </button>
        </div>
    </div>

    <!-- Session Screen -->
    <div id="sessionScreen" class="hidden session-screen">
        <div style="background: white; border-bottom: 1px solid #e5e7eb; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
            <div style="max-width: 64rem; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 id="sessionSubject" style="font-size: 1.5rem; font-weight: 700; color: #1f2937;"></h2>
                    <p id="sessionTopic" style="color: #4b5563; font-weight: 500;"></p>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%); padding: 0.75rem 1.5rem; border-radius: 0.75rem; display: flex; align-items: center; gap: 0.75rem;">
                        <svg style="width: 1.5rem; height: 1.5rem; color: #4f46e5;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span id="timer" style="font-size: 1.5rem; font-weight: 700; color: #4f46e5;">10:00</span>
                    </div>
                    <button onclick="endSession()" class="btn" style="background: #e5e7eb; border-radius: 0.75rem; font-weight: 600; padding: 0.75rem 1.5rem;">
                        End Session
                    </button>
                </div>
            </div>
        </div>

        <div id="messagesContainer" style="flex: 1; overflow-y: auto; padding: 2rem;">
            <div id="messagesList" style="max-width: 56rem; margin: 0 auto; display: flex; flex-direction: column; gap: 1.5rem;"></div>
        </div>

        <div style="background: white; border-top: 1px solid #e5e7eb; padding: 2rem; box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);">
            <div style="max-width: 56rem; margin: 0 auto;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 2rem; margin-bottom: 1rem;">
                    <div id="speakingIndicator" class="hidden animate-pulse" style="display: flex; align-items: center; gap: 0.75rem; color: #9333ea;">
                        <svg style="width: 1.5rem; height: 1.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                        </svg>
                        <span style="font-weight: 600;">AI is speaking...</span>
                    </div>
                    
                    <button id="micButton" onclick="toggleListening()" class="mic-button">
                        <svg style="width: 2.5rem; height: 2.5rem; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                        </svg>
                    </button>

                    <div id="listeningIndicator" class="hidden animate-pulse" style="display: flex; align-items: center; gap: 0.75rem; color: #dc2626;">
                        <div style="width: 0.75rem; height: 0.75rem; background: #dc2626; border-radius: 50%;"></div>
                        <span style="font-weight: 600;">Listening...</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-bottom: 1rem;">
                    <p id="voiceStatus" style="color: #4b5563; font-weight: 500;">üëÜ Click the mic and start speaking</p>
                    <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem;">üí° Tip: Speak clearly and naturally</p>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="textInput" placeholder="Or type your response here..." class="input-field" style="flex: 1;" onkeypress="if(event.key==='Enter') sendTextMessage()">
                    <button onclick="sendTextMessage()" class="btn" style="background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%); color: white; border-radius: 0.75rem; font-weight: 600; padding: 0.75rem 1.5rem;">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Screen -->
    <div id="summaryScreen" class="hidden screen">
        <div class="card">
            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="width: 6rem; height: 6rem; background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                    <svg style="width: 3rem; height: 3rem; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                    </svg>
                </div>
                <h2 style="font-size: 2.25rem; font-weight: 700; color: #1f2937; margin-bottom: 0.75rem;">Session Complete! üéâ</h2>
                <p id="summaryText" style="color: #4b5563; font-size: 1.125rem;"></p>
            </div>

            <div style="background: linear-gradient(135deg, #eef2ff 0%, #faf5ff 100%); border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                <div class="grid-2" style="margin-bottom: 1.5rem;">
                    <div style="background: white; border-radius: 0.75rem; padding: 1.5rem; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                        <p style="color: #4b5563; font-weight: 600; font-size: 0.875rem; margin-bottom: 0.5rem;">Subject</p>
                        <p id="summarySubject" style="color: #1f2937; font-size: 1.25rem; font-weight: 700;"></p>
                    </div>
                    <div style="background: white; border-radius: 0.75rem; padding: 1.5rem; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                        <p style="color: #4b5563; font-weight: 600; font-size: 0.875rem; margin-bottom: 0.5rem;">Topic</p>
                        <p id="summaryTopic" style="color: #1f2937; font-size: 1.25rem; font-weight: 700;"></p>
                    </div>
                </div>
                <div style="background: white; border-radius: 0.75rem; padding: 1.5rem; text-align: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <p style="color: #4b5563; font-weight: 600; font-size: 0.875rem; margin-bottom: 0.5rem;">Messages Exchanged</p>
                    <p id="messageCount" style="color: #4f46e5; font-size: 1.875rem; font-weight: 700;">0</p>
                </div>
            </div>

            <button onclick="resetSession()" class="btn btn-primary">
                <span style="display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                    <svg style="width: 1.5rem; height: 1.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Start New Session
                </span>
            </button>
        </div>
    </div>

<script>
// API Keys
const GEMINI_API_KEY = 'AIzaSyDgA-_s6Sf5ze3D2FAp0sV4iRqq2dRoXtA';

// Global State
let state = {
    screen: 'setup',
    subject: '',
    topic: '',
    messages: [],
    timeLeft: 600,
    isListening: false,
    isSpeaking: false,
    isActive: false,
    recognition: null,
    synthesis: window.speechSynthesis,
    currentTranscript: '',
    timerInterval: null
};

// Initialize Speech Recognition
function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        state.recognition = new SpeechRecognition();
        state.recognition.continuous = false;
        state.recognition.interimResults = true;
        state.recognition.lang = 'en-IN';
        state.recognition.maxAlternatives = 1;
        
        state.recognition.onresult = (event) => {
            let transcript = '';
            for (let i = 0; i < event.results.length; i++) {
                transcript += event.results[i][0].transcript;
            }
            state.currentTranscript = transcript;
            
            const voiceStatus = document.getElementById('voiceStatus');
            if (voiceStatus && state.isListening) {
                voiceStatus.textContent = `Hearing: "${transcript}"`;
            }
            
            if (event.results[event.results.length - 1].isFinal) {
                setTimeout(() => stopListening(), 500);
            }
        };
        
        state.recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            state.isListening = false;
            updateUI();
            
            const voiceStatus = document.getElementById('voiceStatus');
            if (voiceStatus) {
                if (event.error === 'not-allowed') {
                    voiceStatus.textContent = '‚ùå Microphone access denied. Please allow and reload.';
                } else if (event.error === 'no-speech') {
                    voiceStatus.textContent = 'üé§ No speech detected. Click mic and try again.';
                } else {
                    voiceStatus.textContent = '‚ùå Could not understand. Please try again or type.';
                }
            }
        };
        
        state.recognition.onend = () => {
            state.isListening = false;
            updateUI();
        };
        
        console.log('‚úÖ Speech recognition initialized');
    } else {
        console.warn('‚ö†Ô∏è Speech recognition not supported');
        alert('Voice recognition is not supported in your browser. Please use Chrome, Edge, or Safari. You can still type your responses!');
    }
}

// Subject Selection
function selectSubject(subject) {
    state.subject = subject;
    console.log('Selected subject:', subject);
    
    ['Physics', 'Chemistry', 'Biology'].forEach(subj => {
        const btn = document.getElementById(`btn-${subj}`);
        if (btn) {
            btn.className = subj === subject ? 'btn btn-subject active' : 'btn btn-subject';
        }
    });
}

// Start Session
async function startSession() {
    console.log('üöÄ Starting session...');
    
    const topicInput = document.getElementById('topicInput');
    state.topic = topicInput ? topicInput.value.trim() : '';
    
    if (!state.subject || !state.topic) {
        alert('Please select a subject and enter a topic');
        return;
    }
    
    console.log('Subject:', state.subject, 'Topic:', state.topic);
    
    // Reset state
    state.screen = 'session';
    state.isActive = true;
    state.timeLeft = 600;
    state.messages = [];
    
    // Update UI
    showScreen('session');
    
    const sessionSubject = document.getElementById('sessionSubject');
    const sessionTopic = document.getElementById('sessionTopic');
    if (sessionSubject) sessionSubject.textContent = state.subject;
    if (sessionTopic) sessionTopic.textContent = state.topic;
    
    // Create greeting
    const greeting = `Hey! Let's spend the next 10 minutes understanding ${state.topic} in ${state.subject}. I'm here as your study buddy, not to quiz you, but to explore this concept together. So tell me, what do you already know about ${state.topic}?`;
    
    console.log('üìù Adding greeting message');
    state.messages.push({ role: 'assistant', content: greeting });
    displayMessages();
    
    console.log('üîä Speaking greeting');
    await speak(greeting);
    
    console.log('‚è∞ Starting timer');
    startTimer();
}

// Timer Functions
function startTimer() {
    if (state.timerInterval) {
        clearInterval(state.timerInterval);
    }
    
    state.timerInterval = setInterval(() => {
        if (state.isActive && state.timeLeft > 0) {
            state.timeLeft--;
            updateTimer();
        } else if (state.timeLeft === 0) {
            clearInterval(state.timerInterval);
            endSession();
        }
    }, 1000);
    
    console.log('‚úÖ Timer started');
}

function updateTimer() {
    const mins = Math.floor(state.timeLeft / 60);
    const secs = state.timeLeft % 60;
    const timeString = `${mins}:${secs.toString().padStart(2, '0')}`;
    
    const timerEl = document.getElementById('timer');
    if (timerEl) {
        timerEl.textContent = timeString;
        timerEl.style.color = state.timeLeft < 60 ? '#dc2626' : '#4f46e5';
    }
}

// Voice Control
function toggleListening() {
    if (state.isSpeaking) {
        console.log('‚ö†Ô∏è Cannot listen while speaking');
        return;
    }
    
    if (state.isListening) {
        stopListening();
    } else {
        startListening();
    }
}

function startListening() {
    if (!state.recognition) {
        console.warn('‚ö†Ô∏è Speech recognition not available');
        const voiceStatus = document.getElementById('voiceStatus');
        if (voiceStatus) {
            voiceStatus.textContent = '‚å®Ô∏è Please type your response below';
        }
        return;
    }
    
    if (!state.isListening && !state.isSpeaking) {
        try {
            state.recognition.start();
            state.isListening = true;
            console.log('üé§ Started listening');
            
            const voiceStatus = document.getElementById('voiceStatus');
            if (voiceStatus) {
                voiceStatus.textContent = 'üé§ Listening... Speak now!';
            }
            
            updateUI();
        } catch (error) {
            console.error('‚ùå Failed to start recognition:', error);
        }
    }
}

function stopListening() {
    if (state.recognition && state.isListening) {
        try {
            state.recognition.stop();
        } catch (e) {
            console.log('Recognition already stopped');
        }
        
        state.isListening = false;
        console.log('üõë Stopped listening');
        
        if (state.currentTranscript.trim()) {
            const voiceStatus = document.getElementById('voiceStatus');
            if (voiceStatus) {
                voiceStatus.textContent = 'üí≠ Processing...';
            }
            
            console.log('üì§ Sending message:', state.currentTranscript);
            handleUserMessage(state.currentTranscript.trim());
            state.currentTranscript = '';
        } else {
            const voiceStatus = document.getElementById('voiceStatus');
            if (voiceStatus) {
                voiceStatus.textContent = 'üëÜ Click the mic and start speaking';
            }
        }
        
        updateUI();
    }
}

// Text-to-Speech
function speak(text) {
    return new Promise((resolve) => {
        console.log('üîä Speaking:', text.substring(0, 50) + '...');
        
        state.synthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        
        utterance.rate = 0.95;
        utterance.pitch = 1.05;
        utterance.volume = 1.0;
        utterance.lang = 'en-IN';
        
        const voices = state.synthesis.getVoices();
        const preferredVoice = voices.find(v => 
            v.lang.startsWith('en') && 
            (v.name.includes('Google') || v.name.includes('Natural') || v.name.includes('Premium') || v.name.includes('Female'))
        ) || voices.find(v => v.lang.startsWith('en'));
        
        if (preferredVoice) {
            utterance.voice = preferredVoice;
            console.log('üéôÔ∏è Using voice:', preferredVoice.name);
        }
        
        utterance.onstart = () => {
            state.isSpeaking = true;
            console.log('üîä Speech started');
            updateUI();
        };
        
        utterance.onend = () => {
            state.isSpeaking = false;
            console.log('‚úÖ Speech ended');
            updateUI();
            resolve();
        };
        
        utterance.onerror = (error) => {
            console.error('‚ùå Speech error:', error);
            state.isSpeaking = false;
            updateUI();
            resolve();
        };
        
        state.synthesis.speak(utterance);
    });
}

// Handle User Message
async function handleUserMessage(text) {
    console.log('üì® User message:', text);
    
    // push user's message into state
    state.messages.push({ role: 'user', content: text });
    displayMessages();

    try {
        console.log('ü§ñ Calling Gemini API...');

        // Build conversation history: first message contains the prompt/guidelines
        const conversationHistory = [
            {
                role: "user",
                parts: [{
                    text: `You are a friendly NEET study buddy helping a student revise ${state.subject} - ${state.topic}.

GUIDELINES:
- Act like a peer/friend, not a teacher
- Keep responses short (1‚Äì3 sentences)
- Use simple, conversational language
- Be supportive and encouraging
- Ask conceptual questions, give hints instead of direct answers when appropriate
- Use real-life relatable examples
- Help them truly grasp ${state.topic} in 10 minutes`
                }]
            },
            // Now include entire message history (the recent user message we just pushed will be the last one)
            ...state.messages.map(msg => ({
                role: msg.role === 'assistant' ? 'model' : 'user',
                parts: [{ text: msg.content }]
            }))
        ];

        // Make API call (v1 endpoint)
        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`,
            {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: conversationHistory,
                    generationConfig: {
                        temperature: 0.9,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 200
                    }
                })
            }
        );

        // handle non-OK responses
        if (!response.ok) {
            let errorData;
            try {
                errorData = await response.json();
            } catch (e) {
                errorData = { error: { message: 'Unable to parse error response' } };
            }
            console.error('API Error Response:', errorData);
            throw new Error(`API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
        }

        const data = await response.json();
        console.log('‚úÖ Gemini API response received', data);

        // extract AI text
        const aiMessage = data.candidates?.[0]?.content?.parts?.[0]?.text;
        const finalMessage = aiMessage || "Sorry, I couldn't generate a response. Try again.";

        // push assistant response, display and speak
        state.messages.push({ role: 'assistant', content: finalMessage });
        displayMessages();
        await speak(finalMessage);

    } catch (error) {
        console.error('‚ùå Error calling Gemini API:', error);
        const errorMsg = "Hmm, I'm having trouble processing that. Can you try again?";
        state.messages.push({ role: 'assistant', content: errorMsg });
        displayMessages();
        await speak(errorMsg);
    }
}

// Display Messages
function displayMessages() {
    const messagesList = document.getElementById('messagesList');
    if (!messagesList) return;
    
    messagesList.innerHTML = '';
    console.log('üìù Displaying', state.messages.length, 'messages');
    
    state.messages.forEach((msg, index) => {
        const msgDiv = document.createElement('div');
        msgDiv.style.display = 'flex';
        msgDiv.style.justifyContent = msg.role === 'user' ? 'flex-end' : 'flex-start';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = msg.role === 'user' ? 'message message-user' : 'message message-ai';
        
        const textP = document.createElement('p');
        textP.style.fontSize = '1rem';
        textP.style.lineHeight = '1.6';
        textP.style.margin = '0';
        textP.textContent = msg.content;
        
        contentDiv.appendChild(textP);
        msgDiv.appendChild(contentDiv);
        messagesList.appendChild(msgDiv);
    });
    
    // Scroll to bottom
    const container = document.getElementById('messagesContainer');
    if (container) {
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }
}

// Update UI
function updateUI() {
    const micButton = document.getElementById('micButton');
    const listeningIndicator = document.getElementById('listeningIndicator');
    const speakingIndicator = document.getElementById('speakingIndicator');
    
    if (micButton) {
        if (state.isListening) {
            micButton.className = 'mic-button listening';
        } else {
            micButton.className = 'mic-button';
        }
        micButton.disabled = state.isSpeaking;
    }
    
    if (listeningIndicator) {
        if (state.isListening) {
            listeningIndicator.classList.remove('hidden');
            listeningIndicator.style.display = 'flex';
        } else {
            listeningIndicator.classList.add('hidden');
            listeningIndicator.style.display = 'none';
        }
    }
    
    if (speakingIndicator) {
        if (state.isSpeaking) {
            speakingIndicator.classList.remove('hidden');
            speakingIndicator.style.display = 'flex';
        } else {
            speakingIndicator.classList.add('hidden');
            speakingIndicator.style.display = 'none';
        }
    }
}

// Screen Management
function showScreen(screenName) {
    console.log('üñ•Ô∏è Showing screen:', screenName);
    
    const setupScreen = document.getElementById('setupScreen');
    const sessionScreen = document.getElementById('sessionScreen');
    const summaryScreen = document.getElementById('summaryScreen');
    
    if (setupScreen) {
        if (screenName === 'setup') {
            setupScreen.classList.remove('hidden');
            setupScreen.style.display = 'flex';
        } else {
            setupScreen.classList.add('hidden');
            setupScreen.style.display = 'none';
        }
    }
    
    if (sessionScreen) {
        if (screenName === 'session') {
            sessionScreen.classList.remove('hidden');
            sessionScreen.style.display = 'flex';
        } else {
            sessionScreen.classList.add('hidden');
            sessionScreen.style.display = 'none';
        }
    }
    
    if (summaryScreen) {
        if (screenName === 'summary') {
            summaryScreen.classList.remove('hidden');
            summaryScreen.style.display = 'flex';
        } else {
            summaryScreen.classList.add('hidden');
            summaryScreen.style.display = 'none';
        }
    }
}

// End Session
function endSession() {
    console.log('üõë Ending session');
    
    state.isActive = false;
    state.screen = 'summary';
    
    if (state.timerInterval) {
        clearInterval(state.timerInterval);
    }
    
    if (state.recognition) {
        try {
            state.recognition.stop();
        } catch (e) {
            console.log('Recognition already stopped');
        }
    }
    
    state.synthesis.cancel();
    state.isListening = false;
    state.isSpeaking = false;
    
    showScreen('summary');
    
    const summarySubject = document.getElementById('summarySubject');
    const summaryTopic = document.getElementById('summaryTopic');
    const messageCount = document.getElementById('messageCount');
    const summaryText = document.getElementById('summaryText');
    
    if (summarySubject) summarySubject.textContent = state.subject;
    if (summaryTopic) summaryTopic.textContent = state.topic;
    if (messageCount) messageCount.textContent = state.messages.length;
    if (summaryText) {
        summaryText.textContent = `Great job! You exchanged ${state.messages.length} messages about ${state.topic}. Keep practicing!`;
    }
    
    console.log('‚úÖ Session ended. Total messages:', state.messages.length);
}

// Reset Session
function resetSession() {
    console.log('üîÑ Resetting session');
    
    state.screen = 'setup';
    state.subject = '';
    state.topic = '';
    state.messages = [];
    state.timeLeft = 600;
    state.isListening = false;
    state.isSpeaking = false;
    state.isActive = false;
    state.currentTranscript = '';
    
    if (state.timerInterval) {
        clearInterval(state.timerInterval);
        state.timerInterval = null;
    }
    
    const topicInput = document.getElementById('topicInput');
    if (topicInput) topicInput.value = '';
    
    ['Physics', 'Chemistry', 'Biology'].forEach(subj => {
        const btn = document.getElementById(`btn-${subj}`);
        if (btn) btn.className = 'btn btn-subject';
    });
    
    showScreen('setup');
    console.log('‚úÖ Session reset complete');
}

// Text Input Handler
function sendTextMessage() {
    const textInput = document.getElementById('textInput');
    if (!textInput) return;
    
    const message = textInput.value.trim();
    
    if (message) {
        console.log('‚å®Ô∏è Text message:', message);
        textInput.value = '';
        handleUserMessage(message);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing 10-Min Revision...');
    
    initSpeechRecognition();
    
    // Load voices for speech synthesis
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = () => {
            const voices = speechSynthesis.getVoices();
            console.log('üéôÔ∏è Available voices:', voices.length);
        };
    }
    
    // Trigger voice loading
    speechSynthesis.getVoices();
    
    console.log('‚úÖ Initialization complete');
    console.log('üìã State:', state);
});
</script>
</body>
</html>
